##### Macros

- macro: FileFlow
  condition: sf.type=FF

- macro: FileEvent
  condition: sf.type=FE

- macro: ProcessEvent
  condition: sf.type=PE

- macro: NetworkFlow
  condition: sf.type=NF

- macro: setns_syscall
  condition: FileFlow and sf.opflags = SETNS

- macro: exit_syscall
  condition: ProcessEvent and sf.opflags = EXIT

- macro: exec_syscall
  condition: ProcessEvent and sf.opflags = EXEC

- macro: clone_syscall
  condition: ProcessEvent and sf.opflags = CLONE

- macro: unlink_syscall
  condition: FileEvent and sf.opflags = UNLINK

- macro: setuid_syscall
  condition: ProcessEvent and sf.opflags = SETUID

- macro: rename_syscall
  condition: FileEvent and sf.opflags = RENAME

- macro: mkdir_syscall
  condition: FileEvent and sf.opflags = MKDIR

- macro: rmdir_syscall
  condition: FileEvent and sf.opflags = RMDIR

- macro: link_syscall
  condition: FileEvent and sf.opflags = LINK

- macro: symlink_syscall
  condition: FileEvent and sf.opflags = SYMLINK

- macro: FileOpen
  condition: FileFlow and sf.opflags = OPEN

- macro: file_open_write
  condition: FileOpen and sf.file.is_open_write = true

- macro: file_open_read
  condition: FileOpen and sf.file.is_open_read = true

- macro: file_write
  condition: FileFlow and sf.opflags = WRITE

- macro: file_read
  condition: FileFlow and sf.opflags = READ

- macro: file_read_or_file_opened_for_read
  condition: file_read or file_open_read

- macro: file_write_or_file_opened_for_write
  condition: file_write or file_open_write

- list: _infrastructure_containers
  items: [ocp, openshift, ocs, ceph, csi-provisioner, csi-attacher, csi-snapshotter, container-native-virtualization, ose-local-storage-diskmaker, mcg-core-rhel, rook-ceph-rhel, openshift4, cephcsi-rhel, openshift-service-mesh, distributed-tracing, ose-csi-external]

- macro: infrastructure_containers
  condition: sf.container.image pmatch (_infrastructure_containers)

- macro: nginx_ingress_controller_container
  condition: sf.container.image pmatch (nginx-ingress-controller)

- macro: nvidia_gpu_operator
  condition: sf.container.image pmatch (gpu-operator)

#### Process Clone tuning

- macro: _drop_thread_clone_events
  condition: clone_syscall and sf.proc.pid != sf.proc.tid

- list: _os_level_noisy_process_clone_by_process
  items: [/usr/bin/runc, /usr/libexec/crio/conmon, /proc/self/exe, /usr/bin/crio, /usr/lib/systemd/systemd, /usr/bin/hyperkube, /usr/lib/systemd/systemd-journald, /usr/bin/dpkg-deb, /usr/bin/dpkg, /usr/bin/apt-get, /usr/lib/systemd/systemd-udevd, /usr/bin/apt-config, /var/lib/dpkg/info/vim-runtime.postinst, /usr/bin/docker, /usr/share/debconf/frontend, /usr/lib/apt/apt.systemd.daily, /usr/lib/apt/methods/gpgv, /usr/sbin/sshd, /usr/sbin/syslog-ng, /lib/systemd/systemd-journald, /lib/systemd/systemd-udevd, /usr/bin/apt-key, /var/lib/cni/bin/openshift-sdn, /var/lib/cni/bin/multus, /usr/lib/update-notifier/update-motd-fsck-at-reboot, /usr/bin/appstreamcli, /usr/lib/update-notifier/update-motd-hwe-eol, /usr/lib/update-notifier/apt-check, /usr/bin/run-parts, /usr/lib/update-notifier/update-motd-updates-available, /usr/bin/containerd-shim, /usr/bin/gpgconf, /usr/bin/ceph, /usr/bin/openshift-sdn-node, /usr/bin/ldd, /usr/bin/kubelet, /usr/libexec/nm-dispatcher, /usr/bin/ldd, /usr/bin/kubelet, /usr/local/bin/kubectl]

- list: _os_level_noisy_process_clone_by_parent_process
  items: [/usr/bin/runc, /usr/bin/hyperkube, /usr/bin/dpkg, /usr/bin/apt-get, /usr/bin/apt-key, /usr/bin/appstreamcli, /usr/bin/containerd, /var/lib/dpkg/info/vim.postinst, /usr/libexec/nm-dispatcher]

- list: _openshift_infrastructure_container_noisy_process_clone_by_process
  items: [/usr/share/openvswitch/scripts/ovs-ctl, /usr/bin/runc, grpc_health_probe, /prometheus/sh, /usr/bin/dig, /usr/libexec/crio/conmon, /usr/bin/crio, /usr/local/bin/rook, /usr/bin/appregistry-server, /usr/sbin/haproxy, /usr/sbin/tuned-adm, /usr/bin/bash, "\u003cNA\u003e", /usr/bin/nmstatectl, /usr/bin/diskmaker, /usr/local/bin/kubernetes-nmstate, /opt/ibm/java/jre/bin/java, /usr/bin/node, /usr/bin/ansible-runner, /usr/libexec/qemu-kvm, /usr/local/bin/cephcsi, /usr/bin/machine-config-daemon, /bin/sh, /usr/bin/ansible-playbook, /usr/bin/python2, /usr/bin/python2.7, /usr/bin/ansible-runner, /usr/local/bin/ansible-operator, /usr/bin/uname, /var/lib/haproxy/reload-haproxy, /usr/bin/openshift-router, /usr/bin/curl, /usr/local/bin/sidecar-injector, /usr/local/bin/galley]

- list: _openshift_infrastructure_container_noisy_process_clone_by_parent_process
  items: [/usr/bin/runc, /usr/libexec/crio/conmon, /usr/bin/crio, /bin/bash, /usr/bin/sh, /usr/bin/bash, /usr/share/openvswitch/scripts/ovs-ctl, /proc/self/exe, /usr/bin/ceph, /usr/bin/openshift-tuned, /usr/sbin/tuned-adm, /usr/bin/python2, /usr/bin/ansible-runner, /usr/bin/ansible-playbook]

- macro: _drop_out_noisy_process_clone_events_from_ansible
  condition: clone_syscall and ansible_in_infrastructure_containers

- macro: bash_and_parent_process_proc_self_exe_with_cri_grandparents
  condition: (sf.proc.exe = /bin/bash or sf.proc.oldexe = /bin/bash) and (sf.pproc.exe = /proc/self/exe or sf.pproc.oldexe = /proc/self/exe)
             and (sf.proc.aexe in (/usr/bin/runc) and sf.proc.aexe in (/usr/libexec/crio/conmon) and sf.proc.aexe in (/usr/bin/crio))

- macro: _drop_out_noisy_process_clone_events_from_bash_proc_self_exe
  condition: clone_syscall and bash_and_parent_process_proc_self_exe_with_cri_grandparents

- macro: _drop_out_noisy_process_clone_events
  condition: clone_syscall
             and (((sf.proc.exe in (_os_level_noisy_process_clone_by_process) or sf.proc.oldexe in (_os_level_noisy_process_clone_by_process)) or (sf.pproc.exe in (_os_level_noisy_process_clone_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_process_clone_by_parent_process)))
                  or (infrastructure_containers and ((sf.proc.exe in (_openshift_infrastructure_container_noisy_process_clone_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_process_clone_by_process)) or (sf.pproc.exe in (_openshift_infrastructure_container_noisy_process_clone_by_parent_process) or sf.pproc.oldexe in (_openshift_infrastructure_container_noisy_process_clone_by_parent_process)))))

#### File Read tuning

- list: _os_level_noisy_file_read_by_process
  items: [/usr/bin/hyperkube, /usr/lib/systemd/systemd, /usr/bin/runc, /usr/libexec/crio/conmon, /usr/bin/crio, /usr/lib/systemd/systemd-journald, /usr/sbin/sshd, /lib/systemd/systemd-journald, /usr/sbin/irqbalance, /lib/systemd/systemd, /usr/bin/dbus-daemon, /usr/bin/updatedb.mlocate, /lib/systemd/systemd-udevd, /usr/bin/apt-config, /lib/systemd/system-generators/systemd-sysv-generator, /usr/sbin/cron, /usr/bin/dpkg, /usr/bin/mandb, /bin/systemctl, /usr/bin/apt-get, /usr/bin/lsb_release, /usr/bin/dockerd, /bin/networkctl, /sbin/ldconfig.real, /lib/systemd/systemd-sysctl, /lib/systemd/systemd-networkd, /usr/bin/docker, /usr/bin/containerd-shim, /usr/sbin/syslog-ng, /lib/systemd/systemd-resolved, /usr/bin/kubelet, /usr/bin/mongod, /usr/bin/mongo, /usr/bin/prometheus, /usr/lib/accountsservice/accounts-daemon, /usr/lib/systemd/systemd-logind, /usr/lib/systemd/systemd-cgroups-agent, /usr/lib/policykit-1/polkitd, /usr/bin/dpkg-divert, /usr/lib/update-notifier/apt-check, /usr/lib/systemd/systemd-resolved, /usr/bin/apt-key, /usr/bin/hwe-support-status, /usr/sbin/dpkg-preconfigure, /usr/lib/cnf-update-db, /usr/bin/appstreamcli, /usr/bin/gpg-connect-agent, /usr/lib/packagekit/packagekitd, /usr/libexec/gsd-housekeeping, /usr/bin/systemd-detect-virt, /usr/bin/networkctl, /usr/lib/systemd/systemd-networkd, /usr/sbin/rsyslogd, /usr/sbin/NetworkManager, /usr/bin/id, /usr/bin/containerd, /usr/bin/update-alternatives, /usr/bin/gdbus, /usr/bin/dpkg-maintscript-helper, /usr/bin/find, /usr/lib/systemd/systemd-udevd, /usr/bin/test, /usr/libexec/nm-dispatcher, /usr/bin/logger, /usr/libexec/chrony-helper, /usr/sbin/agetty, /usr/bin/basename, /usr/sbin/sssd, /usr/bin/ceph, /usr/lib/polkit-1/polkitd, /usr/sbin/lsof, /usr/bin/date, /usr/bin/systemd-tmpfiles, /usr/sbin/unbound-anchor]

- list: _os_level_noisy_file_read_by_parent_process
  items: [/usr/bin/runc, /usr/libexec/crio/conmon, /usr/bin/hyperkube, /usr/bin/crio, /usr/lib/systemd/systemd, /usr/bin/apt-get, /usr/bin/dpkg-deb, /usr/sbin/sshd, /usr/bin/run-parts, /bin/run-parts, /usr/bin/apt-key, /usr/lib/ubuntu-release-upgrader/release-upgrade-motd, /usr/bin/dpkg, /usr/share/debconf/frontend, /usr/bin/dockerd, /var/lib/dpkg/info/vim.postinst, /usr/sbin/add-shell, /usr/local/bin/docker-compose, /var/lib/dpkg/info/mime-support.postinst, /usr/lib/systemd/systemd-udevd, /var/lib/cni/bin/openshift-sdn, /var/lib/dpkg/info/vim-runtime.postinst, /usr/lib/update-notifier/update-motd-updates-available, /usr/lib/update-notifier/update-motd-hwe-eol, /usr/lib/apt/methods/gpgv, /usr/bin/appstreamcli, /usr/libexec/gnome-session-binary, /usr/lib/update-notifier/update-motd-fsck-at-reboot, /usr/bin/gpgconf, /usr/bin/ldd, /usr/bin/kubelet, /usr/sbin/sssd, /usr/libexec/nm-dispatcher]

- list: _openshift_infrastructure_container_noisy_file_read_by_process
  items: [/usr/bin/node_exporter, /usr/bin/curl, /usr/bin/ovs-vsctl, /usr/bin/ovs-appctl, /usr/bin/prometheus, /usr/bin/ceph, /usr/bin/ceph-mds, /usr/bin/ceph-mgr, /usr/bin/ceph-osd, /usr/local/bin/rook, /usr/bin/ceph-mon, /sbin/ldconfig, /usr/sbin/ldconfig, /usr/bin/ovs-ofctl, /usr/share/openvswitch/scripts/ovs-ctl, /usr/share/grafana/bin/grafana-server, /bin/bash, /rootfs/usr/bin/journalctl, /usr/bin/cat, /usr/bin/sed, /usr/bin/sleep, /usr/bin/thanos, /usr/bin/bash, /usr/bin/openshift-router, /usr/bin/alertmanager, /usr/bin/dockerregistry, /usr/bin/dig, /usr/bin/tail, /usr/bin/ls, /usr/bin/kube-rbac-proxy, /usr/bin/cp, /usr/bin/coredns, /usr/bin/machine-config-daemon, /usr/bin/oauth-proxy, /usr/bin/telemeter-client, /usr/bin/kube-state-metrics, /usr/bin/grep, /usr/bin/openshift-state-metrics, /usr/bin/prometheus-config-reloader, /usr/bin/cmp, /usr/bin/openshift-tuned, /usr/local/bin/helm-operator, /manager, /usr/sbin/ovs-vswitchd, /usr/bin/appregistry-server, /usr/share/grafana/bin/grafana-server, /usr/bin/uname, /usr/sbin/ovsdb-server, /usr/sbin/haproxy, /usr/bin/nmstatectl, /usr/bin/lsblk, /usr/bin/uname, /bin/lsblk, /bin/lsblk, /usr/bin/stat, /usr/bin/realpath, /usr/bin/systemd-run, /usr/local/bin/kubectl, /usr/sbin/libvirtd, /usr/src/ovs-cni/bin/ovs-marker, /usr/bin/virt-handler, /usr/bin/machine-config-controller, /usr/bin/cm-adapter, /usr/bin/ingress-operator, /usr/bin/openshift-controller-manager, /usr/bin/openshift-sdn-controller, /usr/bin/cluster-node-tuning-operator, /usr/bin/dns-operator, /machine-api-operator, /usr/bin/cluster-autoscaler-operator, /usr/bin/snapshot-controller, /usr/bin/ansible-playbook, /usr/bin/ansible-runner, /usr/local/bin/envoy, /usr/sbin/grafana-server, /usr/local/bin/ansible-operator, /bridge-marker, /usr/bin/diskmaker, /usr/bin/jaeger-operator, /usr/local/bin/sidecar-injector, /usr/bin/csi-resizer, /usr/bin/csi-provisioner, /usr/local/bin/mixs, /usr/bin/hostpath-provisioner-operator, /var/lib/haproxy/reload-haproxy, /manager, /usr/sbin/logrotate, /usr/bin/virt-cdi-operator, /usr/bin/virt-operator, /usr/libexec/qemu-kvm, /usr/bin/vm-import-controller, /usr/bin/node, /usr/bin/virt-cdi-controller, /usr/bin/vm-import-operator, /usr/share/grafana/bin/grafana-server, /usr/local/bin/kubernetes-nmstate, /usr/bin/virt-cdi-apiserver, /usr/local/bin/istio-operator, /usr/sbin/udevadm]

- list: _openshift_infrastructure_container_noisy_file_read_by_parent_process
  items: [/usr/libexec/crio/conmon, /usr/bin/runc, /usr/bin/machine-config-daemon, /usr/share/openvswitch/scripts/ovs-ctl, /usr/bin/openshift-tuned, /usr/bin/crio, /usr/local/bin/rook, /usr/local/bin/rook, /rook/rook, /usr/bin/ceph, /usr/bin/dumb-init, /usr/bin/openshift-sdn-node, /usr/sbin/ovsdb-server, /usr/sbin/tuned-adm, /usr/bin/nmstatectl, /usr/bin/node, /usr/bin/ansible-runner, /usr/bin/ansible-playbook]

- macro: _drop_out_noisy_file_read_events_from_nginx_ingress_controller
  condition: file_read_or_file_opened_for_read and nginx_ingress_controller_container and (sf.pproc.exe = /usr/bin/dumb-init or sf.pproc.oldexe = /usr/bin/dumb-init)

- macro: _drop_out_noisy_file_read_events_from_specific_high_level_dirs
  condition: file_read_or_file_opened_for_read
             and (sf.file.directory startswith /usr
              or sf.file.directory startswith /proc
              or sf.file.directory startswith /sys
              or sf.file.directory startswith /lib
              or sf.file.directory startswith //sys
              or sf.file.directory startswith /dev
              or sf.file.directory startswith /tmp)

- macro: _drop_out_noisy_file_read_events_from_pipes_and_sockets
  condition: file_read_or_file_opened_for_read and sf.file.type in (u, p)

- macro: _drop_noisy_file_read_from_ansible_in_infrastructure_containers
  condition: file_read_or_file_opened_for_read and ansible_in_infrastructure_containers

- macro: _drop_out_noisy_file_read_events_from_nvidia_gpu_operator
  condition: file_read_or_file_opened_for_read and nvidia_gpu_operator and (sf.proc.exe = /usr/bin/gpu-operator or sf.proc.oldexe = /usr/bin/gpu-operator)
             and (sf.file.directory startswith /opt/gpu-operator
                  or sf.file.directory startswith /var/run
                  or sf.file.path = /host-etc/os-release)

- macro: _drop_file_read_list_of_file_paths
  condition: file_read_or_file_opened_for_read
              and sf.file.path in (/etc/ld.so.cache)

- macro: _drop_file_read_in_infrastructure_containers_list_of_file_paths
  condition: file_read_or_file_opened_for_read
              and (sf.file.path in (/etc/python, /etc/localtime, /etc/resolv.conf, /etc/hosts, /etc/nsswitch.conf, /etc/host.conf, /etc/passwd)
                   or (sf.file.directory startswith /opt/ansible))

## macro to define /proc/self/exe running in a host, its grandparents includes /usr/bin/runc, /usr/libexec/crio/conmon and /usr/bin/crio
## and not exists sf.container.type -> or another way to limit it to the host
## the second macro looking for proc.exe /bin/bash and pproc.exe: /proc/self/exe

- macro: proc_self_exe_running_in_host_with_cri_grandparents
  condition: (sf.proc.exe = /proc/self/exe or sf.proc.oldexe = /proc/self/exe)
             and (sf.proc.aexe in (/usr/bin/runc) and sf.proc.aexe in (/usr/libexec/crio/conmon) and sf.proc.aexe in (/usr/bin/crio))

- macro: _drop_out_noisy_file_read_events_from_proc_self_exe
  condition: file_read_or_file_opened_for_read and (proc_self_exe_running_in_host_with_cri_grandparents or bash_and_parent_process_proc_self_exe_with_cri_grandparents)
              and sf.file.path in (/etc/group, /etc/passwd, /etc/nsswitch.conf)

- macro: _drop_out_noisy_file_read_events
  condition: file_read_or_file_opened_for_read and not (file_write_or_file_opened_for_write or setns_syscall)
              and (((sf.proc.exe in (_os_level_noisy_file_read_by_process) or sf.proc.oldexe in (_os_level_noisy_file_read_by_process)) or (sf.pproc.exe in (_os_level_noisy_file_read_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_file_read_by_parent_process)))
                    or (infrastructure_containers and ((sf.proc.exe in (_openshift_infrastructure_container_noisy_file_read_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_file_read_by_process)) or (sf.pproc.exe in (_openshift_infrastructure_container_noisy_file_read_by_parent_process) or sf.pproc.oldexe in (_openshift_infrastructure_container_noisy_file_read_by_parent_process)))))

#### File Modify tuning

- list: _os_level_noisy_file_modify_by_process
  items: [/usr/bin/runc, /usr/libexec/crio/conmon, /usr/bin/crio, /usr/bin/hyperkube, /usr/lib/systemd/systemd-logind, /usr/lib/systemd/systemd-journald, /usr/lib/systemd/systemd-udevd, /usr/sbin/NetworkManager, /usr/lib/systemd/systemd, /usr/bin/dbus-daemon, /usr/bin/apt-get, /usr/lib/update-notifier/apt-check, /usr/bin/dpkg, /usr/bin/dockerd, /usr/lib/apt/methods/gpgv, /usr/bin/update-alternatives, /usr/bin/lsb_release, /usr/bin/containerd, /usr/lib/systemd/systemd-networkd, /usr/lib/systemd/systemd-resolved, /usr/bin/kubelet, /usr/sbin/irqbalance, /usr/bin/ceph]

- list: _os_level_noisy_file_modify_by_parent_process
  items: [/usr/libexec/crio/conmon, /usr/bin/runc, /usr/bin/hyperkube, /usr/bin/crio, /usr/lib/systemd/systemd, /usr/sbin/sshd, /usr/bin/dbus-daemon, /usr/bin/dockerd, /lib/systemd/systemd-journald, /lib/systemd/systemd, /lib/systemd/systemd-udevd, /lib/systemd/systemd-logind, /lib/systemd/systemd-timesyncd, /lib/systemd/systemd-resolved, /lib/systemd/systemd-networkd, /usr/bin/dpkg, /usr/lib/systemd/systemd, /usr/bin/update-mime-database, /usr/lib/systemd/systemd-journald, /usr/lib/systemd/systemd-networkd, /usr/lib/systemd/systemd-udevd, /usr/lib/systemd/systemd-resolved, /usr/lib/systemd/systemd-timesyncd, /usr/lib/systemd/systemd-logind, /usr/bin/dpkg-deb, /usr/bin/apt-get, /usr/local/bin/docker-compose, /usr/bin/apt-key, /usr/bin/update-alternatives, /usr/bin/containerd, /usr/bin/appstreamcli, /usr/lib/update-notifier/update-motd-updates-available, /usr/bin/apt-config, /usr/lib/apt/methods/gpgv, /usr/lib/update-notifier/update-motd-fsck-at-reboot, /usr/lib/update-notifier/apt-check, /var/lib/dpkg/info/vim.postinst, /usr/bin/kubelet]

- list: _openshift_infrastructure_container_noisy_file_modify_by_process
  items: [/usr/share/openvswitch/scripts/ovs-ctl, /usr/sbin/ovs-vswitchd, /usr/bin/curl, /usr/bin/cat, /usr/bin/sh, /usr/bin/oauth-proxy, /usr/bin/ovs-vsctl, /usr/bin/ovs-appctl, /usr/bin/sed, /usr/sbin/ovsdb-server, /usr/bin/appregistry-server, /usr/sbin/haproxy, /usr/bin/dig, /sbin/ldconfig, /usr/bin/ceph-osd, /usr/local/bin/rook, /usr/bin/ovs-ofctl, /usr/bin/ls, /usr/bin/grep, /usr/bin/prometheus-config-reloader, /usr/bin/ceph-mds, /usr/bin/openshift-tuned, /usr/bin/openshift-state-metrics, /usr/bin/openshift-router, /usr/sbin/tuned-adm, /usr/sbin/chronyd, /usr/bin/alertmanager, /usr/sbin/tuned-adm, /usr/bin/nmstatectl, /usr/bin/lsblk, /usr/bin/virt-launcher, /usr/src/ovs-cni/bin/ovs-marker, /usr/sbin/libvirtd, /usr/local/bin/sidecar-injector, /usr/sbin/rsyslogd, /usr/sbin/grafana-server, /usr/sbin/logrotate, /usr/libexec/qemu-kvm, /usr/bin/ansible-playbook, /usr/share/grafana/bin/grafana-server]

- list: _openshift_infrastructure_container_noisy_file_modify_by_parent_process
  items: [/usr/share/openvswitch/scripts/ovs-ctl, /usr/sbin/ovs-vswitchd, /usr/bin/dumb-init, /usr/local/bin/rook, /usr/bin/openshift-sdn-node, /usr/bin/virt-launcher]

- macro: _drop_out_noisy_file_modify_events
  condition: file_write_or_file_opened_for_write and not setns_syscall
             and (((sf.proc.exe in (_os_level_noisy_file_modify_by_process) or sf.proc.oldexe in (_os_level_noisy_file_modify_by_process)) or (sf.pproc.exe in (_os_level_noisy_file_modify_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_file_modify_by_parent_process)))
                   or (infrastructure_containers and ((sf.proc.exe in (_openshift_infrastructure_container_noisy_file_modify_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_file_modify_by_process)) or (sf.pproc.exe in (_openshift_infrastructure_container_noisy_file_modify_by_parent_process) or sf.pproc.oldexe in (_openshift_infrastructure_container_noisy_file_modify_by_parent_process)))))

- macro: _drop_file_write_list_of_file_paths
  condition: file_write_or_file_opened_for_write
             and sf.file.path in (/run/systemd/userdb/io.systemd.DynamicUser, /run/systemd/notify, /dev/pts/1, /dev/null, /proc/self/attr/keycreate, /var/lib/grafana/grafana.db-journal)

- macro: _drop_file_write_in_infrastructure_containers_list_of_file_paths
  condition: file_write_or_file_opened_for_write and infrastructure_containers
             and sf.file.path in (/tmp/health)

- macro: _drop_file_write_from_rsyslogd_and_auditd
  condition: file_write_or_file_opened_for_write
             and (sf.proc.exe in (/usr/sbin/rsyslogd, /usr/sbin/auditd) or sf.proc.oldexe in (/usr/sbin/rsyslogd, /usr/sbin/auditd))
             and sf.file.directory startswith /var/log

- macro: _drop_file_write_from_sshd_to_unix_domain
  condition: file_write_or_file_opened_for_write
             and (sf.proc.exe = /usr/sbin/sshd or sf.proc.oldexe = /usr/sbin/sshd)
             and sf.file.type = u

- macro: _drop_file_write_from_os_processes_to_pipes
  condition: file_write_or_file_opened_for_write
             and (sf.pproc.exe = /usr/bin/ldd or sf.pproc.oldexe = /usr/bin/ldd)
             and sf.file.type = p

- macro: _drop_file_write_from_tar
  condition: file_write_or_file_opened_for_write
             and (sf.proc.exe = /usr/bin/tar or sf.proc.oldexe = /usr/bin/tar)
             and sf.file.directory = /var/lib/dpkg/tmp.ci

- macro: _drop_file_write_from_auditd
  condition: file_write_or_file_opened_for_write
             and (sf.proc.exe = 	/usr/sbin/auditd or sf.proc.oldexe = 	/usr/sbin/auditd)
             and sf.file.directory = /var/log/audit/

- macro: ansible_in_infrastructure_containers
  condition: infrastructure_containers
             and ((sf.proc.exe in (/usr/bin/ansible-playbook, /usr/bin/ansible-runner, /usr/local/bin/ansible-operator) or sf.proc.oldexe in (/usr/bin/ansible-playbook, /usr/bin/ansible-runner, /usr/local/bin/ansible-operator)) or sf.proc.aexe in (/usr/bin/ansible-playbook, /usr/local/bin/ansible-operator))

- macro: _drop_noisy_file_write_from_ansible_in_infrastructure_containers
  condition: file_write_or_file_opened_for_write
             and ansible_in_infrastructure_containers
             and (sf.file.directory startswith /tmp
                  or sf.file.directory startswith /tmp/ansible-operator/
                  or sf.file.directory startswith /opt/ansible/
                  or sf.file.directory startswith /dev/pts)

- macro: _drop_write_from_infrastructure_containers_to_pipe_or_unix_domain_socket
  condition: file_write_or_file_opened_for_write and infrastructure_containers
             and sf.file.type in (p, u)

- macro: _drop_file_write_from_infrastructure_containers_to_unix_socket
  condition: file_write_or_file_opened_for_write and infrastructure_containers
             and sf.file.type = u
             and ((sf.proc.exe in (/usr/bin/nmstatectl, /usr/bin/lsblk, /usr/bin/virt-launcher, /usr/sbin/libvirtd, /usr/bin/node, /usr/local/bin/cephcsi, /usr/libexec/qemu-kvm, /usr/bin/virt-handler) or sf.proc.oldexe in (/usr/bin/nmstatectl, /usr/bin/lsblk, /usr/bin/virt-launcher, /usr/sbin/libvirtd, /usr/bin/node, /usr/local/bin/cephcsi, /usr/libexec/qemu-kvm, /usr/bin/virt-handler))
                 or (sf.pproc.exe in (/usr/bin/node) or sf.pproc.oldexe in (/usr/bin/node)))

- macro: _drop_file_write_from_some_processes_to_unix_socket
  condition: file_write_or_file_opened_for_write
             and sf.file.type = u
             and ((sf.proc.exe in (/usr/bin/ldd, /usr/bin/kubelet, /usr/libexec/sssd/sssd_nss) or sf.proc.oldexe in (/usr/bin/ldd, /usr/bin/kubelet, /usr/libexec/sssd/sssd_nss))
                 or (sf.pproc.exe in (/usr/bin/ldd, /usr/bin/kubelet) or sf.pproc.oldexe in (/usr/bin/ldd, /usr/bin/kubelet)))

- macro: _drop_file_write_from_nvidia_gpu_operator_to_unix_socket_and_pipes
  condition: file_write_or_file_opened_for_write and nvidia_gpu_operator
             and sf.file.type in (u, p)
             and (sf.proc.exe = /usr/bin/gpu-operator or sf.proc.oldexe = /usr/bin/gpu-operator)

- macro: _drop_file_write_from_kubelet_specific_file_paths
  condition: file_write_or_file_opened_for_write
             and (sf.proc.exe = 	/usr/bin/kubelet or sf.proc.oldexe = 	/usr/bin/kubelet)
             and (sf.file.directory startswith /sys/fs/cgroup/
                 or sf.file.directory startswith /var/lib/kubelet/pods/)

- macro: _drop_file_write_from_nginx_ingress_controller
  condition: file_write_or_file_opened_for_write and nginx_ingress_controller_container and sf.file.path = /tmp/nginx-status-server.sock

- macro: _drop_file_write_from_proc_self_exe_part_1
  condition: file_write_or_file_opened_for_write and proc_self_exe_running_in_host_with_cri_grandparents
              and ((sf.file.path startswith /proc/self/task/ and sf.file.path contains /attr/exec)
                    or sf.file.path = /proc/thread-self/attr/exec)

## the following case results in around 60k events /proc/self/exe writing to a unix domain, file details are null

- macro: _drop_file_write_from_proc_self_exe_part_2
  condition: file_write_or_file_opened_for_write and proc_self_exe_running_in_host_with_cri_grandparents and sf.file.type in (u, p)

#### Process exit tuning

- macro: _drop_thread_exit_events
  condition: exit_syscall and sf.proc.pid != sf.proc.tid

- list: _os_level_noisy_process_exit_by_process
  items: [/usr/bin/runc, /usr/libexec/crio/conmon, /proc/self/exe, /usr/bin/crio, /usr/lib/systemd/systemd, /usr/sbin/sshd, /usr/bin/dpkg-deb, /usr/bin/apt-key, /usr/bin/dpkg, /usr/bin/apt-config, /usr/bin/cat, /usr/bin/cmp, /usr/bin/dpkg-split, /usr/lib/systemd/systemd-udevd, /usr/bin/sed, /usr/bin/readlink, /usr/lib/update-notifier/update-motd-fsck-at-reboot, /usr/bin/lsb_release, /var/lib/dpkg/info/vim-runtime.postinst, /usr/lib/apt/methods/gpgv, /usr/bin/test, /usr/bin/ldd, /usr/libexec/chrony-helper, /usr/lib/systemd/systemd-cgroups-agent, /usr/bin/basename, /usr/bin/logger, /usr/bin/ldd, /usr/bin/ceph, /usr/sbin/lsof, /usr/bin/jq, /usr/bin/sleep, /usr/bin/ls, /usr/bin/rm, /usr/bin/uname, /usr/sbin/haproxy, /usr/sbin/pidof, /var/lib/haproxy/reload-haproxy, /usr/bin/openshift-router]

- list: _os_level_noisy_process_exit_by_parent_process
  items: [/usr/bin/runc, /usr/bin/hyperkube, /usr/bin/apt-key, /usr/bin/dpkg-deb, /usr/bin/dpkg, /usr/bin/apt-config, /usr/bin/apt-get, /usr/lib/update-notifier/update-motd-fsck-at-reboot, /var/lib/dpkg/info/vim-runtime.postinst, /usr/lib/systemd/systemd-udevd, /usr/bin/appstreamcli, /usr/lib/update-notifier/apt-check, /usr/lib/apt/methods/gpgv, /usr/bin/run-parts, /usr/lib/update-notifier/update-motd-updates-available, /usr/lib/ubuntu-release-upgrader/release-upgrade-motd, /var/lib/dpkg/info/vim.postinst, /usr/bin/dpkg-maintscript-helper, /usr/sbin/cron, /usr/bin/ldd, /usr/bin/kubelet, /usr/libexec/nm-dispatcher, /usr/bin/ldd]

- list: _openshift_infrastructure_container_noisy_process_exit_by_process
  items: [/usr/share/openvswitch/scripts/ovs-ctl, /usr/bin/sleep, /usr/bin/cat, /usr/bin/curl, /usr/bin/bash, /usr/bin/ovs-vsctl, /usr/bin/sh, /bin/bash, /usr/bin/ovs-appctl, /usr/bin/sed, /usr/bin/ovs-ofctl, /proc/self/exe, /prometheus/sh, /usr/bin/runc, /usr/bin/sed, /usr/bin/cp, /usr/bin/ls, /usr/bin/ceph, /usr/sbin/ldconfig, /usr/bin/grep, /usr/bin/cmp, /usr/bin/dig, /usr/libexec/crio/conmon, /usr/bin/lsblk, /sbin/ldconfig, /usr/bin/uname, /usr/bin/nmstatectl, /usr/bin/grep, /usr/bin/sleep, /usr/bin/stat, /usr/bin/realpath, /usr/bin/mkdir, /usr/bin/date, /usr/bin/ansible-runner, /usr/bin/logger, /usr/sbin/logrotate, /usr/bin/find, /bin/sh, /usr/bin/ansible-playbook, /usr/bin/python2, /usr/bin/python2.7, /usr/bin/chmod, /usr/bin/coreutils]

- list: _openshift_infrastructure_container_noisy_process_exit_by_parent_process
  items: [/usr/share/openvswitch/scripts/ovs-ctl, /usr/bin/runc, /usr/bin/ceph, /usr/local/bin/rook, /usr/libexec/crio/conmon, /usr/bin/openshift-sdn-node, /usr/bin/nmstatectl, /usr/bin/ansible-runner, /usr/bin/node, /usr/local/bin/cephcsi, /usr/bin/python2, /usr/bin/ansible-playbook]

- macro: _drop_out_noisy_process_exit_events_from_bash_proc_self_exe
  condition: exit_syscall and bash_and_parent_process_proc_self_exe_with_cri_grandparents

- macro: _drop_out_noisy_process_exit_events
  condition: exit_syscall
             and (((sf.proc.exe in (_os_level_noisy_process_exit_by_process) or sf.proc.oldexe in (_os_level_noisy_process_exit_by_process)) or (sf.pproc.exe in (_os_level_noisy_process_exit_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_process_exit_by_parent_process)))
                   or (infrastructure_containers and ((sf.proc.exe in (_openshift_infrastructure_container_noisy_process_exit_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_process_exit_by_process)) or (sf.pproc.exe in (_openshift_infrastructure_container_noisy_process_exit_by_parent_process) or sf.pproc.oldexe in (_openshift_infrastructure_container_noisy_process_exit_by_parent_process)))))

#### setns tuning

- list: _os_level_noisy_setns_events_by_process
  items: [/usr/bin/runc, /var/lib/cni/bin/openshift-sdn, /usr/bin/dockerd]

- list: _os_level_noisy_setns_events_by_parent_process
  items: [/usr/bin/crio, /usr/bin/dockerd]

- macro: _drop_out_noisy_setns_events_events
  condition: setns_syscall and ((sf.proc.exe in (_os_level_noisy_setns_events_by_process) or sf.proc.oldexe in (_os_level_noisy_setns_events_by_process)) or (sf.pproc.exe in (_os_level_noisy_setns_events_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_setns_events_by_parent_process)))

- macro: _drop_noisy_setns_events_from_proc_self_exe
  condition: setns_syscall and proc_self_exe_running_in_host_with_cri_grandparents

#### Process execution tuning

- list: _os_level_noisy_process_execution_by_process
  items: [/usr/bin/runc, /usr/libexec/crio/conmon, /usr/sbin/sshd, /usr/bin/dpkg, /usr/bin/dpkg-deb, /usr/bin/dpkg-split, /usr/lib/update-notifier/apt-check, /usr/bin/gpg-connect-agent, /usr/bin/lsb_release, /usr/bin/update-alternatives, /usr/bin/date, /usr/bin/test, /usr/libexec/chrony-helper, /usr/libexec/nm-dispatcher, /usr/lib/systemd/systemd-cgroups-agent, /usr/bin/basename, /usr/bin/logger, /usr/bin/nice, /usr/bin/ceph, /usr/sbin/lsof]

- list: _os_level_noisy_process_execution_by_parent_process
  items: [/usr/bin/hyperkube, /usr/bin/runc, /usr/bin/crio, /usr/libexec/crio/conmon, /usr/bin/dpkg, /usr/bin/dpkg-deb, /usr/bin/apt-key, /usr/bin/apt-get, /usr/bin/apt-config, /usr/share/debconf/frontend, /var/lib/dpkg/info/vim-runtime.postinst, /usr/lib/apt/apt.systemd.daily, /usr/bin/run-parts, /usr/lib/update-notifier/apt-check, /usr/lib/update-notifier/update-motd-fsck-at-reboot, /usr/bin/appstreamcli, /usr/bin/gpgconf, /usr/lib/apt/methods/gpgv, /usr/bin/kubelet, /usr/bin/ldd, /usr/libexec/nm-dispatcher]

- list: _openshift_infrastructure_container_noisy_process_execution_by_process
  items: [/usr/sbin/iptables, /usr/sbin/chroot, /usr/bin/curl, /usr/bin/ovs-vsctl, /usr/share/openvswitch/scripts/ovs-ctl, /usr/bin/sed, /usr/bin/ovs-appctl, /usr/bin/ovs-ofctl, /usr/sbin/iptables-save, /usr/bin/openshift-sdn-node, /sbin/ldconfig, /usr/bin/ceph, /usr/bin/ls, /usr/bin/cp, /usr/sbin/ldconfig, /usr/bin/cmp, /usr/bin/dig, /usr/bin/grep, /proc/self/exe, /usr/bin/lsblk, /sbin/ldconfig, /usr/bin/uname, /usr/bin/nmstatectl, /usr/bin/grep, /usr/bin/sleep, /usr/bin/stat, /usr/bin/realpath, /usr/bin/cat, /usr/bin/df, /usr/bin/mkdir, /usr/bin/systemd-run, /usr/local/bin/kubectl, /usr/bin/ansible-runner, /usr/bin/find, /usr/bin/jq]

- list: _openshift_infrastructure_container_noisy_process_execution_by_parent_process
  items: [/usr/bin/openshift-sdn-node, /usr/share/openvswitch/scripts/ovs-ctl, /usr/local/bin/rook, /usr/bin/ceph, /usr/bin/ceph-mgr, /var/lib/haproxy/reload-haproxy, /usr/bin/openshift-router, /usr/bin/openshift-tuned, /usr/bin/nmstatectl, /usr/bin/node, /usr/bin/ansible-runner, /usr/bin/ansible-playbook]

- macro: _drop_out_noisy_process_execution_events_from_ansible
  condition: exec_syscall and ansible_in_infrastructure_containers

- macro: _drop_out_noisy_process_execution_events_from_bash_proc_self_exe
  condition: exec_syscall and bash_and_parent_process_proc_self_exe_with_cri_grandparents

- macro: _drop_out_noisy_process_execution_events
  condition: exec_syscall
             and (((sf.proc.exe in (_os_level_noisy_process_execution_by_process) or sf.proc.oldexe in (_os_level_noisy_process_execution_by_process)) or (sf.pproc.exe in (_os_level_noisy_process_execution_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_process_execution_by_parent_process)))
                   or (infrastructure_containers and ((sf.proc.exe in (_openshift_infrastructure_container_noisy_process_execution_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_process_execution_by_process)) or (sf.pproc.exe in (_openshift_infrastructure_container_noisy_process_execution_by_parent_process) or sf.pproc.oldexe in (_openshift_infrastructure_container_noisy_process_execution_by_parent_process)))))

### File delete tuning

- list: _os_level_noisy_file_delete_by_process
  items: [/usr/bin/crio, /usr/bin/hyperkube, /usr/bin/runc, /usr/lib/systemd/systemd-udevd, /usr/lib/systemd/systemd, /usr/libexec/crio/conmon, /lib/systemd/systemd-udevd, /usr/bin/apt-get, /usr/bin/dpkg, /usr/bin/update-alternatives, /usr/bin/dockerd, /usr/lib/systemd/systemd-networkd, /usr/bin/containerd, /usr/lib/apt/methods/gpgv, /usr/lib/ubuntu-release-upgrader/check-new-release, /usr/bin/containerd-shim, /usr/lib/systemd/systemd-resolved, /usr/lib/systemd/systemd-logind, /usr/lib/systemd/systemd-journald, /usr/bin/dpkg-divert, /usr/bin/appstreamcli, /usr/bin/kubelet, /usr/sbin/logrotate]

- list: _os_level_noisy_file_delete_by_parent_process
  items: [/usr/bin/runc, /usr/bin/apt-get, /usr/bin/dpkg, /usr/bin/appstreamcli, /usr/lib/update-notifier/update-motd-updates-available, /usr/bin/apt-key]

- list: _openshift_infrastructure_container_noisy_file_delete_by_process
  items: [/usr/bin/appregistry-server, /usr/local/bin/rook, /usr/bin/prometheus, /usr/bin/ceph-mon, /usr/share/grafana/bin/grafana-server, /usr/bin/openshift-tuned, /usr/sbin/tuned-adm, /usr/bin/prometheus-config-reloader, /usr/bin/ansible-runner, /usr/bin/prometheus-config-reloader, /usr/local/bin/galley, /usr/bin/ansible-runner, /usr/bin/ansible-playbook, /usr/bin/prometheus, /usr/local/bin/ansible-operator, /usr/sbin/grafana-server, /usr/sbin/haproxy]

- macro: _drop_out_noisy_file_deletion_events_from_ansible
  condition: unlink_syscall and ansible_in_infrastructure_containers

- macro: _drop_out_noisy_file_delete_events
  condition: unlink_syscall
             and (((sf.proc.exe in (_os_level_noisy_file_delete_by_process) or sf.proc.oldexe in (_os_level_noisy_file_delete_by_process)) or (sf.pproc.exe in (_os_level_noisy_file_delete_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_file_delete_by_parent_process)))
                  or (infrastructure_containers and (sf.proc.exe in (_openshift_infrastructure_container_noisy_file_delete_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_file_delete_by_process))))

### Network Flows tuning

- list: _os_level_noisy_network_flows_by_process
  items: [/usr/bin/crio, /usr/sbin/haproxy, /usr/bin/hyperkube, /usr/sbin/chronyd, /var/lib/cni/bin/multus, /usr/bin/coredns, /usr/lib/systemd/systemd-resolved, /usr/bin/kubelet, /usr/sbin/unbound-anchor, /usr/sbin/NetworkManager, /usr/sbin/sssd]

- list: _os_level_noisy_network_flows_by_parent_process
  items: [/usr/bin/runc, /usr/bin/apt-get]

- list: _openshift_infrastructure_container_noisy_network_flows_by_process
  items: [/usr/bin/ceph, /usr/bin/oauth-proxy, /usr/bin/thanos, /usr/bin/kube-rbac-proxy, /usr/bin/ceph-osd, /usr/bin/prom-kube-proxy, /usr/bin/alertmanager, /usr/local/bin/rook, /usr/bin/ceph-mds, /usr/bin/cm-adapter, /usr/bin/telemeter-client, /usr/share/grafana/bin/grafana-server, /usr/bin/machine-config-daemon, /usr/bin/node_exporter, /usr/bin/openshift-tuned, /usr/bin/kube-state-metrics, /usr/bin/openshift-state-metrics, /usr/bin/openshift-router, /usr/bin/dig, /usr/bin/node, /usr/bin/nmstatectl, /usr/local/bin/mixs, /usr/sbin/grafana-server, /go/bin/collector-linux, /go/bin/query-linux, /go/bin/all-in-one-linux, /opt/kiali/kiali, /usr/bin/ansible-playbook, /usr/local/bin/ansible-operator, /usr/local/bin/envoy, /usr/src/ovs-cni/bin/ovs-marker, /bridge-marker, /opt/kiali/kiali, /usr/bin/virt-handler, /usr/local/bin/noobaa-operator, /usr/local/bin/kubectl, /usr/bin/virt-operator, /usr/bin/virt-cdi-apiserver, /usr/bin/csi-provisioner, /usr/bin/csi-attacher, /usr/bin/diskmaker, /usr/local/bin/ocs-operator, /usr/bin/csi-resizer, /usr/bin/jaeger-operator, /usr/bin/snapshot-controller, /usr/bin/cluster-node-tuning-operator, /usr/bin/virt-cdi-operator, /usr/bin/hostpath-provisioner-operator, /usr/bin/local-storage-operator, /usr/bin/vm-import-operator, /usr/bin/ansible-runner, /usr/bin/virt-cdi-controller, /usr/local/bin/kubernetes-nmstate, /usr/bin/vm-import-controller, /usr/bin/openshift-sdn-node, /usr/bin/radosgw-admin, /usr/local/bin/pilot-discovery, /usr/bin/appregistry-server]

- list: _openshift_infrastructure_container_noisy_network_flows_by_parent_process
  items: [/usr/libexec/crio/conmon, /var/lib/haproxy/reload-haproxy]

- macro: _drop_out_noisy_network_flows_from_runc_parent_process
  condition: NetworkFlow and (sf.pproc.exe = /usr/bin/runc or sf.pproc.oldexe = /usr/bin/runc) and sf.net.dip = 127.0.0.1 and sf.net.dport in (9, 9090, 50051)

- macro: _drop_out_noisy_network_flows_from_curl
  condition: NetworkFlow and infrastructure_containers and (sf.proc.exe = /usr/bin/curl or sf.proc.oldexe = /usr/bin/curl) and sf.net.dip = 127.0.0.1 and sf.net.dport = 9090

- macro: _drop_out_noisy_network_flows_from_ansible
  condition: NetworkFlow and ansible_in_infrastructure_containers

- macro: _drop_out_network_flows_from_log_forwarder_utilities
  condition: NetworkFlow and (sf.proc.exe in (/usr/sbin/syslog-ng) or sf.proc.oldexe in (/usr/sbin/syslog-ng)) and sf.net.dport = 514

- macro: _drop_out_noisy_network_flows
  condition: NetworkFlow
             and ( ((sf.proc.exe in (_os_level_noisy_network_flows_by_process) or sf.proc.oldexe in (_os_level_noisy_network_flows_by_process)) or (sf.pproc.exe in (_os_level_noisy_network_flows_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_network_flows_by_parent_process)))
             or (infrastructure_containers and ((sf.proc.exe in (_openshift_infrastructure_container_noisy_network_flows_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_network_flows_by_process)) or (sf.pproc.exe in (_openshift_infrastructure_container_noisy_network_flows_by_parent_process) or sf.pproc.oldexe in (_openshift_infrastructure_container_noisy_network_flows_by_parent_process)))))

### setuid tuning

- list: _os_level_noisy_setuid_events_by_process
  items: [/usr/bin/runc, /usr/sbin/sshd, /usr/lib/systemd/systemd, /usr/libexec/crio/conmon]

- macro: _drop_noisy_setuid_events_from_proc_self_exe
  condition: setuid_syscall and proc_self_exe_running_in_host_with_cri_grandparents

- macro: _drop_out_noisy_setuid_events
  condition: setuid_syscall
             and (sf.proc.exe in (_os_level_noisy_setuid_events_by_process) or sf.proc.oldexe in (_os_level_noisy_setuid_events_by_process))

### File rename tuning

- list: _os_level_noisy_file_rename_events_by_process
  items: [/usr/bin/runc, /usr/bin/hyperkube, /lib/systemd/systemd-udevd, /usr/bin/dpkg, /usr/lib/systemd/systemd-udevd, /usr/sbin/NetworkManager, /usr/bin/crio, /usr/libexec/crio/conmon, /usr/lib/systemd/systemd, /usr/lib/systemd/systemd-journald, /usr/sbin/logrotate, /usr/bin/dockerd, /usr/bin/kubelet, /usr/sbin/chronyd]

- list: _openshift_infrastructure_container_noisy_file_rename_events_by_process
  items: [/usr/bin/alertmanager, /usr/bin/prometheus, /usr/bin/prometheus-config-reloader, /usr/bin/ansible-runner, /usr/bin/ansible-playbook, /usr/sbin/ovsdb-server]

- macro: _drop_out_noisy_file_rename_events_from_ansible
  condition: rename_syscall and ansible_in_infrastructure_containers

- macro: _drop_out_noisy_file_rename_events_from_mongodb
  condition: rename_syscall and sf.container.image pmatch (mongodb) and sf.file.path in (/data/mongo/cluster/shard1/diagnostic.data/metrics.interim.temp, /data/mongo/cluster/shard1/WiredTiger.turtle.set)

- macro: _drop_out_noisy_file_rename_events
  condition: rename_syscall
             and (((sf.proc.exe in (_os_level_noisy_file_rename_events_by_process) or sf.proc.oldexe in (_os_level_noisy_file_rename_events_by_process)))
                   or (infrastructure_containers and (sf.proc.exe in (_openshift_infrastructure_container_noisy_file_rename_events_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_file_rename_events_by_process))))

### Directory Creation tuning

- list: _os_level_noisy_directory_creation_by_process
  items: [/usr/bin/dpkg, /usr/lib/systemd/systemd, /usr/bin/apt-get, /usr/bin/update-mime-database, /usr/bin/dpkg-deb, /usr/bin/dockerd, /usr/lib/systemd/systemd-logind, /usr/bin/runc, /usr/sbin/update-rc.d, /usr/bin/containerd, /usr/local/bin/docker-compose, /usr/bin/top, /usr/bin/containerd-shim, /usr/bin/kubelet, /usr/local/bin/kubectl, /usr/bin/crio, /usr/lib/systemd/systemd-journald]

- list: _os_level_noisy_directory_creation_by_parent_process
  items: [/usr/bin/dpkg-deb, /var/lib/dpkg/info/shared-mime-info.postinst, /usr/bin/containerd-shim, /usr/bin/apt-get, /usr/bin/containerd-shim, /usr/bin/containerd, /usr/bin/apt-key]

- list: _openshift_infrastructure_container_noisy_directory_creation_by_process
  items: [/usr/bin/oc, /usr/bin/python2, /usr/bin/ansible-runner, /usr/bin/prometheus]

- macro: _drop_out_noisy_directory_creation_in_infrastructure_containers_list_of_file_paths
  condition: mkdir_syscall
             and ( sf.file.path in (/opt/ansible/.ansible, /opt/ansible, /opt)
                   or (sf.file.path startswith /opt/ansible/.ansible or sf.file.path startswith /tmp/ansible-operator))

- macro: _drop_out_noisy_directory_creation_events
  condition: mkdir_syscall
             and (((sf.proc.exe in (_os_level_noisy_directory_creation_by_process) or sf.proc.oldexe in (_os_level_noisy_directory_creation_by_process)) or (sf.pproc.exe in (_os_level_noisy_directory_creation_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_directory_creation_by_parent_process)))
                 or (infrastructure_containers and (sf.proc.exe in (_openshift_infrastructure_container_noisy_directory_creation_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_directory_creation_by_process))))

### Directory Removal tuning

- list: _os_level_noisy_directory_removal_by_process
  items: [/usr/bin/appstreamcli, /usr/lib/systemd/systemd, /usr/bin/apt-get, /usr/bin/dpkg, /usr/bin/hyperkube, /usr/bin/prometheus]

- list: _os_level_noisy_directory_removal_by_parent_process
  items: [/usr/bin/dpkg, /usr/lib/systemd/systemd, /usr/bin/apt-get]

- macro: _drop_out_noisy_directory_removal_from_ansible
  condition: rmdir_syscall and ansible_in_infrastructure_containers

- macro: _drop_out_noisy_directory_removal_events
  condition: rmdir_syscall
             and ((sf.proc.exe in (_os_level_noisy_directory_removal_by_process) or sf.proc.oldexe in (_os_level_noisy_directory_removal_by_process)) or (sf.pproc.exe in (_os_level_noisy_directory_removal_by_parent_process) or sf.pproc.oldexe in (_os_level_noisy_directory_removal_by_parent_process)))

### Soft Link tuning

- list: _os_level_noisy_soft_link_creation_by_process
  items: [/usr/bin/dpkg, /usr/bin/apt-get, /usr/bin/update-alternatives, /usr/lib/systemd/systemd, /usr/bin/dockerd, /usr/sbin/update-rc.d, /usr/bin/hyperkube, /usr/lib/systemd/systemd-udevd, /usr/bin/kubelet, /usr/libexec/crio/conmon, /usr/bin/crio]

- list: _openshift_infrastructure_container_noisy_soft_link_creation_by_process
  items: [/usr/local/bin/ansible-operator, /usr/bin/runc, /usr/bin/virt-operator]

- macro: _drop_out_noisy_soft_link_creation_events
  condition: symlink_syscall
             and ((sf.proc.exe in (_os_level_noisy_soft_link_creation_by_process) or sf.proc.oldexe in (_os_level_noisy_soft_link_creation_by_process))
             or (infrastructure_containers and (sf.proc.exe in (_openshift_infrastructure_container_noisy_soft_link_creation_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_soft_link_creation_by_process))))

### Hard Link tuning

- list: _os_level_noisy_hard_link_creation_by_process
  items: [/usr/bin/dpkg, /usr/bin/dpkg-divert]

- list: _openshift_infrastructure_container_noisy_hard_link_creation_by_process
  items: [/usr/bin/ansible-runner, /usr/bin/ansible-playbook]

- macro: _drop_out_noisy_hard_link_creation_events
  condition: link_syscall
             and ((sf.proc.exe in (_os_level_noisy_hard_link_creation_by_process) or sf.proc.oldexe in (_os_level_noisy_hard_link_creation_by_process))
                 or (infrastructure_containers and (sf.proc.exe in (_openshift_infrastructure_container_noisy_hard_link_creation_by_process) or sf.proc.oldexe in (_openshift_infrastructure_container_noisy_hard_link_creation_by_process))))

- macro: _drop_out_noisy_directory_creation_events
  condition: mkdir_syscall
             and ((sf.proc.exe in (_os_level_noisy_directory_creation_by_process) or sf.pproc.exe in (_os_level_noisy_directory_creation_by_parent_process))
                 or (infrastructure_containers and sf.proc.exe in (_openshift_infrastructure_container_noisy_directory_creation_by_process)))

##### Global drop rule

- drop: __global__
  condition: _drop_out_noisy_process_clone_events
             or _drop_thread_clone_events
             or _drop_out_noisy_process_clone_events_from_ansible
             or _drop_out_noisy_process_clone_events_from_bash_proc_self_exe
             or _drop_out_noisy_file_read_events
             or _drop_out_noisy_file_read_events_from_nginx_ingress_controller
             or _drop_out_noisy_file_read_events_from_nvidia_gpu_operator
             or _drop_file_read_list_of_file_paths
             or _drop_out_noisy_file_read_events_from_proc_self_exe
             or _drop_out_noisy_file_read_events_from_specific_high_level_dirs
             or _drop_out_noisy_file_read_events_from_pipes_and_sockets
             or _drop_noisy_file_read_from_ansible_in_infrastructure_containers
             or _drop_file_read_in_infrastructure_containers_list_of_file_paths
             or _drop_out_noisy_file_modify_events
             or _drop_file_write_list_of_file_paths
             or _drop_file_write_in_infrastructure_containers_list_of_file_paths
             or _drop_file_write_from_rsyslogd_and_auditd
             or _drop_file_write_from_tar
             or _drop_file_write_from_auditd
             or _drop_file_write_from_os_processes_to_pipes
             or _drop_file_write_from_kubelet_specific_file_paths
             or _drop_file_write_from_infrastructure_containers_to_unix_socket
             or _drop_file_write_from_some_processes_to_unix_socket
             or _drop_file_write_from_sshd_to_unix_domain
             or _drop_file_write_from_nginx_ingress_controller
             or _drop_file_write_from_nvidia_gpu_operator_to_unix_socket_and_pipes
             or _drop_noisy_file_write_from_ansible_in_infrastructure_containers
             or _drop_write_from_infrastructure_containers_to_pipe_or_unix_domain_socket
             or _drop_file_write_from_proc_self_exe_part_1
             or _drop_file_write_from_proc_self_exe_part_2
             or _drop_thread_exit_events
             or _drop_out_noisy_process_exit_events_from_bash_proc_self_exe
             or _drop_out_noisy_process_exit_events
             or _drop_out_noisy_setns_events_events
             or _drop_noisy_setns_events_from_proc_self_exe
             or _drop_out_noisy_process_execution_events
             or _drop_out_noisy_process_execution_events_from_ansible
             or _drop_out_noisy_process_execution_events_from_bash_proc_self_exe
             or _drop_out_noisy_file_delete_events
             or _drop_out_noisy_file_deletion_events_from_ansible
             or _drop_out_noisy_network_flows_from_runc_parent_process
             or _drop_out_network_flows_from_log_forwarder_utilities
             or _drop_out_noisy_network_flows_from_curl
             or _drop_out_noisy_network_flows_from_ansible
             or _drop_out_noisy_network_flows
             or _drop_out_noisy_setuid_events
             or _drop_noisy_setuid_events_from_proc_self_exe
             or _drop_out_noisy_file_rename_events
             or _drop_out_noisy_file_rename_events_from_ansible
             or _drop_out_noisy_file_rename_events_from_mongodb
             or _drop_out_noisy_directory_creation_events
             or _drop_out_noisy_directory_removal_from_ansible
             or _drop_out_noisy_directory_creation_in_infrastructure_containers_list_of_file_paths
             or _drop_out_noisy_directory_removal_events
             or _drop_out_noisy_soft_link_creation_events
             or _drop_out_noisy_hard_link_creation_events
             or _drop_out_transwarp_events



#################################
##############TTPS###############
#################################

###### Lists ####################

- list: shell_binaries
  items: [bash, csh, ksh, sh, tcsh, zsh, dash]

- list: shell_mgmt_binaries
  items: [add-shell, remove-shell]

- list: script_interpreters
  items: [ruby, python, python2.7, python2, python3, python3.5, java, perl, node, js24]

- list: shell_interpreters
  items: [awk, gawk]

- list: coreutils_binaries
  items: [
    truncate, sha1sum, numfmt, fmt, fold, uniq, cut, who,
    groups, csplit, sort, expand, printf, printenv, unlink, tee, chcon, stat,
    basename, split, nice, "yes", whoami, sha224sum, hostid, users, stdbuf,
    base64, unexpand, cksum, od, paste, nproc, pathchk, sha256sum, wc, test,
    comm, arch, du, factor, sha512sum, md5sum, tr, runcon, env, dirname,
    tsort, join, shuf, install, logname, pinky, nohup, expr, pr, tty, timeout,
    tail, "[", seq, sha384sum, nl, head, id, mkfifo, sum, dircolors, ptx, shred,
    tac, link, chroot, vdir, chown, touch, ls, dd, uname, "true", pwd, date,
    chgrp, chmod, mktemp, cat, mknod, sync, ln, "false", rm, mv, cp, echo,
    readlink, sleep, stty, mkdir, df, dir, rmdir
    ]

- list: coreutils_mod_binaries
  items: [
    truncate, who, groups, csplit, expand, printenv, unlink, chcon, 
    split, whoami, users, stdbuf, unexpand, paste, runcon, env, 
    install, logname, pinky, nohup, tty, id, mkfifo, shred,
    link, chroot, chown, touch, dd, chgrp, chmod, mktemp, mknod, 
    ln, rm, mv, cp, rmdir
    ]

- list: login_binaries
  items: [
    login, systemd, '"(systemd)"', systemd-logind, su,
    nologin, faillog, lastlog, newgrp, sg
    ]

- list: repositories
  items: [git, svn]

 - list: modify_passwd_binaries
  items: [
    chpasswd, chgpasswd, passwd
    ]

- list: verify_passwd_binaries
  items: [ unix_chkpwd ] 

- list: create_user_binaries
  items: [ useradd, newusers ] 

- list: delete_user_binaries
  items: [ userdel ] 

- list: modify_user_binaries
  items: [ usermod ] 

- list: create_grp_binaries
  items: [ groupadd, newusers ]  

- list: delete_group_binaries
  items: [ groupdel ] 

- list: modify_grp_binaries
  items: [ groupmod ] 

- list: user_util_binaries
  items: [
    shadowconfig, grpck, pwunconv, grpconv, pwck,
    vipw, pwconv, cppw, 
    grpunconv, chage, chsh,
    gpasswd, chfn, expiry, vigr, cpgr
    ]

- list: k8s_binaries
  items: [hyperkube, skydns, kube2sky, exechealthz, weave-net]

- list: lxd_binaries
  items: [lxd, lxcfs]

- list: http_server_binaries
  items: [nginx, httpd, httpd-foregroun, lighttpd, apache, apache2, node]

- list: db_server_binaries
  items: [mysqld, postgres, sqlplus]

- list: mysql_mgmt_binaries
  items: [mysql_install_d, mysql_ssl_rsa_s]

- list: postgres_mgmt_binaries
  items: [pg_dumpall, pg_ctl, pg_lsclusters, pg_ctlcluster]

- list: db_mgmt_binaries
  items: [mysql_mgmt_binaries, postgres_mgmt_binaries]

- list: nosql_server_binaries
  items: [couchdb, memcached, redis-server, rabbitmq-server, mongod]

- list: gitlab_binaries
  items: [gitlab-shell, gitlab-mon, gitlab-runner-b, git]

- list: rpm_binaries
  items: [dnf, rpm, rpmkey, yum, '"75-system-updat"', rhsmcertd-worke, subscription-ma,
          repoquery, rpmkeys, rpmq, yum-cron, yum-config-mana, yum-debug-dump,
          abrt-action-sav, rpmdb_stat, microdnf, rhn_check, yumdb]

- list: deb_binaries
  items: [dpkg, dpkg-preconfigu, dpkg-reconfigur, dpkg-divert, apt, apt-get, aptitude,
    frontend, preinst, add-apt-reposit, apt-auto-remova, apt-key,
    apt-listchanges, unattended-upgr, apt-add-reposit
    ]

- list: package_mgmt_binaries
  items: [rpm_binaries, deb_binaries, update-alternat, gem, pip, pip3, sane-utils.post, alternatives, chef-client]

- list: ssl_mgmt_binaries
  items: [ca-certificates]

- list: dhcp_binaries
  items: [dhclient, dhclient-script, 11-dhclient]

- list: mail_binaries
  items: [
    sendmail, sendmail-msp, postfix, procmail, exim4,
    pickup, showq, mailq, dovecot, imap-login, imap,
    mailmng-core, pop3-login, dovecot-lda, pop3
    ]

- list: vpn_binaries
  items: [openvpn]

- list: sys_password_files
  items: [/etc/shadow, /etc/passwd]

- list: sensitive_file_names
  items: [/etc/sudoers, /etc/pam.conf]

- list: cron_binaries
  items: [anacron, cron, crond, crontab]

- list: system_users
  items: [bin, daemon, games, lp, mail, nobody, sshd, sync, uucp, www-data]

- list: system_directories
  items: [/boot, /lib, /lib64, /usr/lib, /usr/local/lib, /usr/local/sbin, /usr/local/bin, /root/.ssh, /etc]

 - list: init_directories
   items: [/etc/init.d]

- list: history_files 
  items: [".bash_history", ".ash_history"]
  
- list: network_config_files
  items: ['/etc/resolv.conf', '/etc/hosts']

- list: read_sensitive_file_binaries
  items: [
    iptables, ps, lsb_release, check-new-relea, dumpe2fs, accounts-daemon, sshd,
    vsftpd, systemd, mysql_install_d, psql, screen, debconf-show, sa-update,
    pam-auth-update, pam-config, spamd, polkit-agent-he, lsattr, file, sosreport,
    scxcimservera, adclient, rtvscand, cockpit-session, userhelper, ossec-syscheckd
    ]
    
- list: downloader_binaries
  items: [wget, curl]
  
- list: remote_copy_binaries
  items: [scp, rsync, telnet, ssh, ftp, rcp, sftp]

- list: known_root_files
  items: [/root/.monit.state, /root/.auth_tokens, /root/.bash_history, /root/.ash_history, /root/.aws/credentials,
          /root/.viminfo.tmp, /root/.lesshst, /root/.bzr.log, /root/.gitconfig.lock, /root/.babel.json, 
          /root/.localstack, /root/.node_repl_history, /root/.mongorc.js, /root/.dbshell, /root/.augeas/history, 
          /root/.rnd, /root/.wget-hsts]

- list: known_root_directories
  items: [/root/.oracle_jre_usage, /root/.subversion, /root/.nami]

- list: profile_files
  items: [".bashrc", ".bash_profile", ".profile"]

- list: ld_preload_files
  items: ["/etc/ld.so.preload"]

- list: scheduler_files
  items: [/etc/crontab] 

- list: scheduler_directories
  items: ["/etc/cron.d", "/etc/cron.daily", "/etc/cron.monthly", "/etc/cron.hourly", "/etc/cron.weekly", 
          "/usr/lib/cron/tabs", "/var/cron/tabs", "/var/spool/cron/crontabs", "/var/spool/cron"] 

- list: protected_shell_spawning_binaries
  items: [
    http_server_binaries, db_server_binaries, nosql_server_binaries, mail_binaries,
    fluentd, flanneld, splunkd, consul, smbd, runsv, PM2
    ]
    
- list: allowed_dev_files
  items: [
    /dev/null, /dev/stdin, /dev/stdout, /dev/stderr,
    /dev/random, /dev/urandom, /dev/console, /dev/kmsg
    ]
    
- list: mesos_shell_binaries
  items: [mesos-docker-ex, mesos-slave, mesos-health-ch]

- list: misc_tools
  items: [calico-node]

- list: edr_tools
  items: [/crowdstrike/cmd.sh, besclient, BESClient]

- list: log_tools
  items: [logdna, splunk, rsyslog]
  
- list: log_paths
  items: [/var/, /tmp/nginx-ingress.private]
  
- list: known_setuid_binaries
  items: [
    sshd, dbus-daemon-lau, ping, ping6, critical-stack-, pmmcli,
    filemng, PassengerAgent, bwrap, osdetect, nginxmng, sw-engine-fpm,
    start-stop-daem
    ]

 - list: userexec_binaries
  items: [sudo, su, suexec, critical-stack, dzdo]

 - list: docker_binaries
  items: [docker, dockerd, exe, docker-compose, docker-entrypoi, docker-runc-cur, docker-current, dockerd-current]

 - list: nomachine_binaries
  items: [nxexec, nxnode.bin, nxserver.bin, nxclient.bin]

 - list: compilers
  items: ["g++", gcc, clang, javac]

- list: shadowutils_binaries
  items: [
    chage, gpasswd, lastlog, newgrp, sg, adduser, deluser, chpasswd,
    groupadd, groupdel, addgroup, delgroup, groupmems, groupmod, grpck, grpconv, grpunconv,
    newusers, pwck, pwconv, pwunconv, useradd, userdel, usermod, vigr, vipw, unix_chkpwd
    ]
    
- list: user_mgmt_binaries
  items: [login_binaries, passwd_binaries, shadowutils_binaries]

- list: privileged_processes
  items: [/usr/bin/sudo, /usr/local/sbin/runc]

- list: auth_processes
  items: [/opt/ibm/java/bin/keytool, /bin/chown, /bin/chmod, /bin/bash]

- list: netcat_cmds
  items: [nc, ncat]

- list: netcat_shell_args
  items: ['-e /bin/sh', '-e /bin/bash']

- list: discovery_cmds
  items: [cat, strings, nl, head, tail]

- list: host_files
  items: [/etc/hosts, .ssh/config]

- list: user_discovery_cmds
  items: [w, who, whoami, id, last]

- list: system_discovery_cmds
  items: [uname, lsb_release, lscpu, lshw, lsmod, lspci, lsscsi, lsblk, hwinfo, hostname, inxi, uptime, dmidecode]

- list: fs_discovery_cmds
  items: [mount, df, tree, find]

- list: net_discovery_cmds
  items: [netstat, ss, lsof] 

- list: keylogger_cmds
  items: [logkeys, lkl]

- list: netconfig_discovery_cmds
  items: [firewall-cmd, ufw, iptables, netstat, ss, ip, ifconfig, systemd-resolve, route]

- list: at_cmds
  items: [at, atd]

- list: remote_copy_cmds
  items: [scp, rsync, sftp]

- list: remote_copy_inds
  items: ['@', ':']

- list: cert_cmds
  items: [update-ca-certificates, update-ca-trust]

- list: security_procs
  items: [nessusd, td-agent, packetbeat, filebeat, auditbeat, osqueryd, cbagentd, falcond]

- list: service_cmds
  items: [service, chkconfig, systemctl]

- list: security_services
  items: [iptables, ip6tables, firewalld, cbdaemon, falcon-sensor]

- list: stop_cmds
  items: [stop, disable, off]

###### Macros ###################

- macro: sed_write
  condition: ((sf.proc.exe contains 'sed' or sf.proc.oldexe contains 'sed') and sf.proc.args contains '-i')

- macro: overwrite
  condition: sf.opflags = RENAME

- macro: open_write
  condition: (sf.opflags in (WRITE_SEND) or
             (sf.opflags = OPEN and sf.file.openflags in (O_CREAT)) or
             sed_write)
  
- macro: open_read
  condition: (sf.file.is_open_read = true or sf.opflags = READ_RECV)
  
- macro: interactive
  condition: >
    ((sf.proc.aname = sshd and sf.proc.name != sshd and sf.proc.oldname != sshd) or
    sf.proc.name = systemd-logind or sf.proc.oldname = systemd-logind or sf.proc.name = login or sf.proc.oldname = login or sf.proc.tty = true)

- macro: user_ssh_directory
  condition: (sf.file.path startswith '/home' and sf.file.path contains '.ssh')

- macro: system_dir
  condition: >
    (sf.file.directory in (system_directories)
     or user_ssh_directory)
     
- macro: init_dir
  condition: >
    (fd.directory in (init_directories))

- macro: scheduler_dir
  condition: >
    (fd.directory in (scheduler_directories))

- macro: known_root_conditions
  condition: (sf.file.path startswith /root/orcexec.
              or sf.file.path startswith /root/.m2
              or sf.file.path startswith /root/.npm
              or sf.file.path startswith /root/.pki
              or sf.file.path startswith /root/.ivy2
              or sf.file.path startswith /root/.config/Cypress
              or sf.file.path startswith /root/.config/pulse
              or sf.file.path startswith /root/.config/configstore
              or sf.file.path startswith /root/jenkins/workspace
              or sf.file.path startswith /root/.jenkins
              or sf.file.path startswith /root/.cache
              or sf.file.path startswith /root/.sbt
              or sf.file.path startswith /root/.java
              or sf.file.path startswith /root/.glide
              or sf.file.path startswith /root/.sonar
              or sf.file.path startswith /root/.v8flag
              or sf.file.path startswith /root/infaagent
              or sf.file.path startswith /root/.local/lib/python
              or sf.file.path startswith /root/.pm2
              or sf.file.path startswith /root/.gnupg
              or sf.file.path startswith /root/.pgpass
              or sf.file.path startswith /root/.theano
              or sf.file.path startswith /root/.gradle
              or sf.file.path startswith /root/.android
              or sf.file.path startswith /root/.ansible
              or sf.file.path startswith /root/.crashlytics
              or sf.file.path startswith /root/.dbus
              or sf.file.path startswith /root/.composer
              or sf.file.path startswith /root/.gconf
              or sf.file.path startswith /root/.nv
              or sf.file.path startswith /root/.local/share/jupyter
              or sf.file.path startswith /root/oradiag_root
              or sf.file.path startswith /root/workspace
              or sf.file.path startswith /root/jvm
              or sf.file.path startswith /root/.node-gyp)

- macro: rename
  condition: sf.opflags = RENAME

- macro: mkdir
  condition: sf.opflags = MKDIR

- macro: remove
  condition: sf.opflags in (RMDIR, UNLINK)

- macro: modify
  condition: rename or remove

- macro: bin_dir
  condition: (sf.file.directory startswith /bin or 
             sf.file.directory startswith /sbin or
             sf.file.directory startswith /usr/bin or
             sf.file.directory startswith /usr/sbin or
             sf.file.directory startswith /usr/local/bin or
             sf.file.directory startswith /usr/local/sbin)

- macro: etc_dir
  condition: sf.file.path startswith /etc/

- macro: root_dir
  condition: (sf.file.directory=/ or sf.file.path startswith /root)

- macro: sensitive_files
  condition: (sf.file.path startswith /etc and
              sf.file.path in (sys_password_files))

- macro: ssh_port
  condition: sf.net.sport=22

- macro: running_shell_command
  condition: sf.proc.cmdline startswith "sh -c"

- macro: parent_linux_image_upgrade_script
  condition: sf.pproc.name startswith linux-image-

- macro: parent_node_running_npm
  condition: (sf.pproc.cmdline startswith "node /usr/local/bin/npm" or
              sf.pproc.cmdline startswith "node /usr/local/nodejs/bin/npm" or
              sf.pproc.cmdline startswith "node /opt/rh/rh-nodejs6/root/usr/bin/npm")

- macro: java_package_installer
  condition: ((sf.proc.name=java or sf.proc.oldname=java) and sf.proc.cmdline contains sbt-launch.jar) or (sf.proc.name=mvn or sf.proc.oldname=mvn)

- macro: ansible_running_python
  condition: ((sf.proc.name in (python, pypy) or sf.proc.oldname in (python, pypy)) and sf.proc.cmdline contains ansible)

- macro: python_running_chef
  condition: ((sf.proc.name=python or sf.proc.oldname=python) and (sf.proc.cmdline contains yum-dump.py or sf.proc.cmdline="python /usr/bin/chef-monitor.py"))

- macro: python_running_get_pip
  condition: (sf.proc.cmdline startswith "python get-pip.py")

- macro: parent_java_running_zookeeper
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains org.apache.zookeeper.server)

- macro: parent_java_running_kafka
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains kafka.Kafka)

- macro: parent_java_running_elasticsearch
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains org.elasticsearch.bootstrap.Elasticsearch)

- macro: parent_java_running_activemq
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains activemq.jar)

- macro: parent_java_running_cassandra
  condition: (sf.pproc.name=java and (sf.proc.cmdline contains "-Dcassandra.config.loader" or sf.pproc.cmdline contains org.apache.cassandra.service.CassandraDaemon))

- macro: parent_java_running_jboss_wildfly
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains org.jboss)

- macro: parent_java_running_glassfish
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains com.sun.enterprise.glassfish)

- macro: parent_java_running_hadoop
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains org.apache.hadoop)

- macro: parent_java_running_datastax
  condition: (sf.pproc.name=java and sf.pproc.cmdline contains com.datastax)

- macro: nginx_starting_nginx
  condition: (sf.pproc.name=nginx and sf.proc.cmdline contains "/usr/sbin/nginx -c /etc/nginx/nginx.conf")

- macro: nginx_running_aws_s3_cp
  condition: (sf.pproc.name=nginx and sf.proc.cmdline startswith "sh -c /usr/local/bin/aws s3 cp")

- macro: consul_running_net_scripts
  condition: (sf.pproc.name=consul and (sf.proc.cmdline startswith "sh -c curl" or sf.proc.cmdline startswith "sh -c nc"))

- macro: consul_running_alert_checks
  condition: (sf.pproc.name=consul and sf.proc.cmdline startswith "sh -c /bin/consul-alerts")

- macro: serf_script
  condition: (sf.proc.cmdline startswith "sh -c serf")

- macro: check_process_status
  condition: (sf.proc.cmdline startswith "sh -c kill -0 ")

- macro: possibly_parent_java_running_tomcat
  condition: (sf.pproc.name contains java and sf.pproc.cmdline contains org.apache.catalina.startup.Bootstrap)

- macro: protected_shell_spawner
  condition: >
    (sf.proc.aname in (protected_shell_spawning_binaries)
    or parent_java_running_zookeeper
    or parent_java_running_kafka
    or parent_java_running_elasticsearch
    or parent_java_running_activemq
    or parent_java_running_cassandra
    or parent_java_running_jboss_wildfly
    or parent_java_running_glassfish
    or parent_java_running_hadoop
    or parent_java_running_datastax
    or possibly_parent_java_running_tomcat)

- macro: nrpe_becoming_nagios
  condition: ((sf.proc.name=nrpe or sf.proc.oldname=nrpe) and sf.proc.username=nagios)

- macro: container
  condition: (sf.container.type != host)

- macro: known_user_in_container
  condition: (container and sf.proc.username != "N/A")

- macro: system_procs
  condition: sf.proc.name in (coreutils_binaries, user_mgmt_binaries) or sf.proc.oldname in (coreutils_binaries, user_mgmt_binaries)

- macro: login_doing_dns_lookup
  condition: ((sf.proc.name=login or sf.proc.oldname=login) and sf.net.proto=udp and sf.net.sport=53)

- macro: inbound_outbound
  condition: >
    ((sf.opflags in (ACCEPT,CONNECT)) or
     (sf.file.typechar = 4 or sf.file.typechar = 6) and
     (sf.net.ip != "0.0.0.0" and sf.net.mask != "127.0.0.0/8") and
     (sf.ret >= 0))

- macro: possibly_webserver
  condition: ((sf.proc.name pmatch (http_server_binaries) or sf.proc.oldname pmatch (http_server_binaries)) 
              or possibly_parent_java_running_tomcat)

- macro: privileged_execution
  condition: (sf.proc.exe in (privileged_processes) or sf.proc.oldexe in (privileged_processes))

- macro: allowed_launchers
  condition: (sf.pproc.exe in (/usr/local/sbin/runc) or sf.pproc.oldexe in (/usr/local/sbin/runc))
             or (sf.proc.exe pmatch (cgi-bin) or sf.proc.oldexe pmatch (cgi-bin))

- macro: auth_execution
  condition: (sf.proc.exe in (auth_processes) or sf.proc.oldexe in (auth_processes))
  
- macro: entrypoint
  condition: not sf.pproc.pid exists

- macro: wl
  condition: (sf.proc.exe in (/echo/echo) or sf.proc.oldexe in (/echo/echo))

- macro: parent_sudo
  condition: (sf.pproc.exe = /usr/bin/sudo or sf.pproc.oldexe = /usr/bin/sudo)

- macro: ps_discovery_args
  condition: (sf.proc.args contains 'e' and sf-process.args contains 'f') or 
             (sf.proc.args contains 'a' and sf-process.args contains 'u' and sf-process.args contains 'x') 

- macro: home_dir_arg
  condition: sf.proc.args endswith '/home' or sf.proc.args endswith '/home/'

- macro: clear_cmds
  condition: ( (sf.proc.name = rm or sf.proc.oldname = rm) or
               (sf.proc.name = shred or sf.proc.oldname = shred) or
               ((sf.proc.name = truncate or sf.proc.oldname = truncate) and sf.prog.args contains '-s0') or
               ((sf.proc.name = ln or sf.proc.oldname = ln) and sf.proc.args contains '-sf /dev/null'))

###### Rules ####################

- rule: Interactive shell
  desc: Interactive shell detected
  condition: interactive and not entrypoint      
  priority: low
  tags: [mitre:T1059]
  
- rule: Command and Scripting Interpreter
  desc: any network activity performed by shell interpreters that are not expected to send or receive any network traffic
  condition: (sf.proc.name in (shell_binaries) or sf.proc.oldname in (shell_binaries))
             and inbound_outbound
             and not login_doing_dns_lookup
             and not entrypoint 
  priority: medium
  tags: [mitre:T1041, mitre:T1059]
  
- rule: Privilege escalation
  desc: Privilege escalation detected
  condition: sf.pproc.uid != 0 and sf.proc.uid = 0 and not entrypoint
  priority: high
  tags: [mitre:T1068]
  
- rule: Untrusted read sensitive file 
  desc: an attempt to read any sensitive file (e.g. files containing user/password/authentication information)
  condition: sensitive_files 
             and open_read 
             and not privileged_execution 
             and not auth_execution 
             and (sf.proc.name in (coreutils_binaries, user_mgmt_binaries) or sf.proc.oldname in (coreutils_binaries, user_mgmt_binaries)) 
             and not entrypoint
  priority: medium
  tags: [mitre:T1087]

- rule: Webserver writing unusual file
  desc: Webserver is writing a file other than a log file
  condition: sf.file.type = f and 
             open_write and 
             possibly_webserver and not sf.file.path pmatch (log_paths)
             and not entrypoint
  priority: medium
  tags: [mitre:T1190]
  prefilter: [FF]

- rule: Suspicious process spawned
  desc: Suspicious behavior observed in application spawning another process
  condition: sf.opflags = EXEC 
             and sf.proc.exe != sf.pproc.exe 
             and not allowed_launchers 
             and (sf.proc.name in (shell_binaries, compilers, pkg_mgmt_binaries, shell_interpreters, coreutils_mod_binaries) or sf.proc.oldname in (shell_binaries, compilers, pkg_mgmt_binaries, shell_interpreters, coreutils_mod_binaries))
             and not entrypoint
  priority: low
  tags: [mitre:T1106, mitre:T1574]
  prefilter: [PE]
  
- rule: Crontab file written
  desc: Crontab file edited
  condition: (sf.file.path in (scheduler_files) and open_write) or
             (sf.file.newpath in (scheduler_files) and overwrite)
  priority: medium
  tags: [mitre:T1053]

- rule: Unauthorized installer detected
  desc: Use of package installer detected in container
  condition: sf.opflags = EXEC and              
             (sf.proc.name pmatch (package_mgmt_binaries, java_package_installer) or sf.proc.oldname pmatch (package_mgmt_binaries, java_package_installer)) and container          
  priority: medium
  tags: [mitre:T1072]
  prefilter: [PE]
  
- rule: User/group modified, added or deleted
  desc: User/Group was modified, added or deleted
  condition: sf.opflags = EXEC and 
             (sf.proc.name in (modify_passwd_binaries, create_user_binaries, delete_user_binaries, modify_user_binaries, create_grp_binaries, delete_group_binaries, modify_grp_binaries) or sf.proc.oldname in (modify_passwd_binaries, create_user_binaries, delete_user_binaries, modify_user_binaries, create_grp_binaries, delete_group_binaries, modify_grp_binaries))
  priority: high
  tags: [mitre:T1098, mitre:T1136]
  prefilter: [PE]

- rule: Downloader detected
  desc: Downloader is being run inside the container. Could be downloading something malicious
  condition: sf.opflags = EXEC and sf.ret = 0 and
             (sf.proc.name pmatch (downloader_binaries) or sf.proc.oldname pmatch (downloader_binaries))
  priority: high
  tags: [mitre:T1105]
  prefilter: [PE]

- rule: Password file modified
  desc: Password file was modified
  condition: sf.file.path pmatch (sys_password_files) and open_write           
  priority: high
  tags: [mitre:T1098]

- rule: Library preload file modified
  desc: Library preload file modified could indicate a library injection attack
  condition: sf.file.path pmatch (ld_preload_files) and open_write           
  priority: medium
  tags: [mitre:T1547, mitre:T1554]

- rule: Remote copy program detected
  desc: Remote copy is occurring; could be data exfiltration
  condition: sf.opflags = EXEC and 
             (sf.proc.name in (remote_copy_binaries) or sf.proc.oldname in (remote_copy_binaries))
  priority: high
  tags: [mitre:T1020]
  prefilter: [PE]
  
 - rule: Password utilities execution 
  desc: Password utilities were run in the host system
  condition: sf.opflags = EXEC and 
             (sf.proc.name pmatch (modify_passwd_binaries, verify_passwd_binaries, user_util_binaries) or sf.proc.oldname pmatch (modify_passwd_binaries, verify_passwd_binaries, user_util_binaries))
  priority: high
  tags: [mitre:T1098]
  prefilter: [PE]

- rule: History file modified
  desc: History file modified indicating interactive session
  condition: sf.file.path pmatch (history_files) and open_write
  priority: high
  tags: [mitre:T1564]

- rule: Profile file modified
  desc: Profile file modified indicating interactive session
  condition: sf.file.path pmatch (profile_files) and open_write
  priority: high
  tags: [mitre:T1098]

- rule: Write below binary dir
  desc: an attempt to write to any file below a set of binary directories
  condition: open_write and bin_dir
  priority: medium
  tags: [mitre:T1574]

- rule: Write below system dirs
  desc: an attempt to write to any file below a set of system directories
  condition: open_write and system_dir and not privileged_execution
  priority: medium
  tags: [mitre:T1574]

- rule: Write to init directories 
  desc: an attempt to write to an init directory could indicate a persisted piece of malware
  condition: open_write and init_dir
  priority: medium
  tags: [mitre:T1574]

- rule: Write to scheduler directories 
  desc: an attempt to write to a scheduler directory could indicate a persisted piece of malware
  condition: open_write and scheduler_dir
  priority: medium
  tags: [mitre:T1053]

- rule: Write below root
  desc: an attempt to write to any file directly below / or /root
  condition: >
    root_dir and open_write
    and not sf.file.path in (known_root_files)
    and not sf.file.directory in (known_root_directories)
    and not known_root_conditions
  priority: high
  tags: [mitre:T1574]

- rule: Write Below RPM/DPKG Database
  desc: an attempt to write to the rpm/dpkg database
  condition: (sf.file.path startswith /var/lib/rpm or 
             sf.file.path startswith /var/lib/dpkg) and 
             open_write
  priority: medium
  tags: [mitre:T1574]

- rule: Change thread namespace
  desc: >
    an attempt to change a program/thread\'s namespace (commonly done
    as a part of creating a container) by calling setns.
  condition: >
    sf.opflags = SETNS
    and not sf.proc.aname in (docker_binaries, k8s_binaries, lxd_binaries)
    and not sf.proc.aname startswith "runc:"
    and not sf.file.path startswith /var/run/netns/cni
  priority: medium
  tags: [mitre:T1574, mitre:T1055]

- rule: Non sudo setuid
  desc: >
    an attempt to change users by calling setuid. sudo/su are excluded. users "root" and "nobody"
    suing to itself are also excluded, as setuid calls typically involve dropping privileges.
  condition: >
    sf.opflags = SETUID
    and (known_user_in_container or not container)
    and sf.proc.username != root 
    and not (sf.proc.name in (known_setuid_binaries, userexec_binaries, mail_binaries, docker_binaries, nomachine_binaries) or sf.proc.oldname in (known_setuid_binaries, userexec_binaries, mail_binaries, docker_binaries, nomachine_binaries))
    and not nrpe_becoming_nagios
  priority: medium
  tags: [mitre:T1068]

- rule: Create files below dev
  desc: creating any files below /dev other than known programs that manage devices. Some rootkits hide files in /dev.
  condition: >
    sf.file.directory = /dev
    and open_write
    and not (sf.proc.name in (dev_creation_binaries) or sf.proc.oldname in (dev_creation_binaries))
    and not sf.file.path in (allowed_dev_files)
    and not sf.file.path startswith /dev/tty
  priority: medium
  tags: [mitre:T1574]

- rule: System procs network activity
  desc: any network activity performed by system binaries that are not expected to send or receive any network traffic
  condition: system_procs
    and inbound_outbound
    and not (sf.proc.name in (systemd, hostid, id) or sf.proc.oldname in (systemd, hostid, id))
    and not login_doing_dns_lookup
    and not entrypoint
    and not wl
  priority: medium
  tags: [mitre:T1543, mitre:T1041]

- rule: Reverse Unix shell started
  desc: creation of a reverse shell process via nc 
  condition: sf.opflags = EXEC and
             (sf.proc.name in (netcat_cmds) or sf.proc.oldname in (netcat_cmds)) and sf.proc.args pmatch (netcat_shell_args)
  priority: high
  tags: [mitre:T1059.004]
  prefilter: [PE]

- rule: Linux and Mac File and Directory Permissions Modification
  desc: modification of permissions or owner of a file or a directory in a linux system
  condition: sf.opflags = EXEC and
             (sf.proc.name in (chmod, chown) or sf.proc.oldname in (chmod, chown))
  priority: high
  tags: [mitre:T1222.002]
  prefilter: [PE]

- rule: Process Discovery
  desc: gather information about running processes on a system
  condition: sf.opflags = EXEC and
             (((sf.proc.name = ps or sf.proc.oldname = ps) and ps_discovery_args) or (sf.proc.name = top or sf.proc.oldname = top))
  priority: high
  tags: [mitre:T1057]
  prefilter: [PE]

- rule: Account Discovery: Local Account
  desc: attempt to get a listing of local system accounts
  condition: sf.opflags = EXEC and
             (sf.proc.name in (discovery_cmds) or sf.proc.oldname in (discovery_cmds)) and sf.proc.args in (sys_password_files)
  priority: high
  tags: [mitre:T1087.001]
  prefilter: [PE]

- rule: Remote System Discovery
  desc: >
    attempt to get a listing of other systems by IP address, hostname, or other logical
    identifier on a network that may be used for Lateral Movement
  condition: sf.opflags = EXEC and
             (sf.proc.name in (discovery_cmds) or sf.proc.oldname in (discovery_cmds)) and sf.proc.args pmatch (host_files)
  priority: high
  tags: [mitre:T1018]
  prefilter: [PE]

- rule: System Owner/User Discovery
  desc: >
    attempt to identify the primary user, currently logged in user, set of users 
    that commonly uses a system, or whether a user is actively using the system
  condition: sf.opflags = EXEC and
             (sf.proc.name in (user_discovery_cmds) or sf.proc.oldname in (user_discovery_cmds))
  priority: high
  tags: [mitre:T1033]
  prefilter: [PE]

- rule: Permission Groups Discovery: Local Groups
  desc: attempt to find local system groups and permission settings
  condition: sf.opflags = EXEC and
             ((sf.proc.name = groups or sf.proc.oldname = groups) or
              ((sf.proc.name in (discovery_cmds) or sf.proc.oldname in (discovery_cmds)) and sf.proc.args = '/etc/groups'))
  priority: high
  tags: [mitre:T1069.001]
  prefilter: [PE]

- rule: System Information Discovery
  desc: >
    attempt to get detailed information about the operating system and hardware,
    including version, patches, hotfixes, service packs, and architecture
  condition: sf.opflags = EXEC and
             (sf.proc.name in (system_discovery_cmds) or sf.proc.oldname in (system_discovery_cmds))
  priority: high
  tags: [mitre:T1082]
  prefilter: [PE]

# partially from https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_file_and_directory_discovery.yml
- rule: File and Directory Discovery
  desc: enumerate files, directories and volume information
  condition: sf.opflags = EXEC and
             (((sf.proc.name = ls or sf.proc.oldname = ls) and (home_dir_arg or sf.proc.args contains '-R')) or
               (sf.proc.name in (fs_discovery_cmds) or sf.proc.oldname in (fs_discovery_cmds)))
  priority: high
  tags: [mitre:T1083]
  prefilter: [PE]

- rule: System Network Connections Discovery
  desc: attempt to get a listing of network connections
  condition: sf.opflags = EXEC and
             (sf.proc.name in (net_discovery_cmds) or sf.proc.oldname in (net_discovery_cmds))
  priority: high
  tags: [mitre:T1049]
  prefilter: [PE]

- rule: Shell started by container entry point 
  desc: Container entry point "node" starts shell sub-process
  condition: sf.opflags = EXEC and
             container and sf.pproc.name = node and (sf.proc.name in (shell_binaries) or sf.proc.oldname in (shell_binaries))
  priority: high
  tags: [mitre:T1059.004]
  prefilter: [PE]

- rule: Large network data transfer with database endpoint
  desc: Large amount of data transferred via network connection with database endpoint
  condition: ( sf.opflags contains RECV and sf.net.dport = 3306 and sf.flow.rbytes > 1024 ) or
             ( sf.opflags contains SEND and sf.net.sport = 3306 and sf.flow.wbytes > 1024 )
  priority: high
  tags: [mitre:T1030]
  prefilter: [NF]

- rule: Active Scanning: Scanning IP Blocks
  desc: Use of nmap to scan for ports on a remote machine
  condition: (sf.proc.name = nmap or sf.proc.oldname = nmap)
  priority: medium
  tags: [mitre:T1595.001]
  prefilter: [PE]

- rule: Input Capture: Keylogging
  desc: Use of keylogger to log user keystrokes
  condition: (sf.proc.name in (keylogger_cmds) or sf.proc.oldname in (keylogger_cmds))
  priority: high
  tags: [mitre:T1056.001]
  prefilter: [PE]

- rule: Account Manipulation: SSH Authorized Keys
  desc: Attempt to modify the SSH authorized_keys file
  condition: user_ssh_directory and (sf.file.path endswith 'authorized_keys') and open_write
  priority: high
  tags: [mitre:T1098.004]
  prefilter: [FF]

- rule: System Network Configuration Modification
  desc: Attempt to modify the system network configuration file
  condition: sf.file.path in (network_config_files) and open_write
  priority: high
  tags: [mitre:T1565.001]
  prefilter: [FF]

# from https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_system_network_discovery.yml
- rule: System Network Configuration Discovery
  desc: Attempt to get details about the network configuration
  condition: sf.opflags = EXEC and
             (((sf.proc.name in (discovery_cmds) or sf.proc.oldname in (discovery_cmds)) and sf.proc.args pmatch (network_config_files)) or
               (sf.proc.name in (netconfig_discovery_cmds) or sf.proc.oldname in (netconfig_discovery_cmds)))
  priority: high
  tags: [mitre:T1016]
  prefilter: [PE]

- rule: Unsecured Credentials: Bash History
  desc: Searching the command history for unprotected credentials
  condition: sf.opflags = EXEC and
             (sf.proc.name in (netconfig_discovery_cmds) or sf.proc.name in (netconfig_discovery_cmds)) and sf.proc.args pmatch (history_files)
  priority: high
  tags: [mitre:T1552.003]
  prefilter: [PE]

# partially from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_shell_clear_cmd_history.yml
- rule: Indicator Removal on Host: Clear Linux or Mac System Logs
  desc: Attempts to clear system logs to hide evidence of an intrusion
  condition: sf.opflags = EXEC and (
             ( sf.proc.args pmatch (history_files) and clear_cmds) or
             ( (sf.proc.name = history or sf.proc.oldname = history) and sf.proc.args = '-c'))
  priority: medium
  tags: [mitre:T1070.003]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/at_command.yml
- rule: Scheduled Task/Job At
  desc: Detects the use of at/atd
  condition: sf.opflags = EXEC and sf.poc.name in (at_cmds)
  priority: low
  tags: [mitre:T1053.001]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_base64_decode.yml
- rule: Decode Base64 Encoded Text
  desc: Detects usage of base64 utility to decode arbitrary base64-encoded text
  condition: sf.opflags = EXEC and (sf.proc.name = base64 or sf.proc.oldname = base64) and sf.proc.args contains '-d'
  priority: low
  tags: [mitre:T1027]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_file_copy.yml
- rule: Remote File Copy
  desc: Detects the use of tools that copy files from or to remote systems
  condition: sf.opflags = EXEC and (sf.proc.name in (remote_copy_cmds) or sf.proc.oldname in (remote_copy_cmds)) and sf.prog.args pmatch (remote_copy_inds)
  priority: low
  tags: [mitre:T1105]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHAQ/sigma/blob/master/rules/linux/lnx_install_root_certificate.yml
- rule: Install Root Certificate
  desc: Detects installation of new root certificates
  condition: sf.opflags = EXEC and (sf.proc.name in (cert_cmds) or sf.proc.oldname in (cert_cmds))
  priority: low
  tags: [mitre:T1553.004]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_schedule_task_job_cron.yml
- rule: Scheduled Task/Job: Cron
  desc: Detects abuse of the cron utility to perform task scheduling for initial or recurring execution
  condition: sf.opflags = EXEC and (sf.proc.name = cron or sf.proc.oldname = cron)
  priority: low
  tags: [mitre:T1053.003]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_security_software_discovery.yml
- rule: Security Software Discovery
  desc: Detects usage of system utilities (only grep for now) to discover security software discovery
  condition: sf.opflags = EXEC and (sf.proc.name = grep or sf.proc.oldname = grep) and sf.proc.args pmatch (security_procs)
  priority: low
  tags: [mitre:T1518.001]
  prefilter: [PE]

# from Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/linux/lnx_security_tools_disabling.yml
- rule: Impair Defenses: Disable or Modify System Firewall
  desc: Detects disabling security tools
  condition: sf.opflags = EXEC and
             (( (sf.proc.name in (service_cmds) or sf.proc.oldname in (service_cmds)) and
               sf.proc.args pmatch (security_services) and
               sf.proc.args pmatch (stop_cmds)) or
             ( (sf.proc.name = setenforce or sf.proc.oldname = setenforce) and sf.proc.args = '0'))
  priority: medium
  tags: [mitre:T1562.004]
  prefilter: [PE]

